<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>todolist</title>
    <script src="../jquery.min.js"></script>
    <style>
        *{
            padding:0;
            margin:0;
            list-style:none;
            box-sizing: border-box;
        }
        html{
            background: #cdcdcd;
        }
        header{
            height:50px;
            background: rgba(47,47,47,0.98);
            font-size: 16px;
        }
        header>section{
            width:600px;
            margin: 0 auto;

        }
        header>section>label{
            float: left;
            width:100px;
            line-height:50px;
            color: #ddd;
            font-size: 24px;
            cursor: pointer;
            font-family: 'Helvetica Neue';
        }
        header>section>input{
            float: right;
            width:60%;
            height:24px;
            margin-top: 12px;
            text-indent: 10px;
            border-radius: 5px;
            box-shadow: 0 1px 0 rgba(255,255,255,0.24),0 1px 6px rgba(0,0,0,0.45) inset;
        }
        body>section{
            width:600px;
            padding:0 10px;
            margin:0 auto;
            font-size: 16px;
        }
        h2{
            display: block;
            font-size: 1.5em;
            margin:19.920px 0;
            position: relative;
        }

        h2>span{
            position: absolute;
            top:2px;
            right:5px;
            display: inline-block;
            padding:0 5px;
            height:20px;
            border-radius: 20px;
            background: #e6e6fa;
            line-height: 22px;
            text-align: center;
            color: #666;
            font-size: 14px;
        }

        ol,ul{
            margin:16px 0;
        }

        li{
            /*cursor: move;*/
            height:32px;
            line-height: 32px;
            background: #fff;
            position: relative;
            margin-bottom: 20px;
            padding:0 45px;
            border-radius: 3px;
            border-left:5px solid #629a9c;
            box-shadow: 0 1px 2px rgba(0,0,0,0.07);
        }

        ul>li{
            border-left: 5px solid #999;
            opacity:0.5;
        }

        li>input{
            position: absolute;
            top:2px;
            left:10px;
            width:22px;
            height:22px;
            cursor: pointer;
            margin:3px 3px 3px 4px;
        }

        li>p{
            line-height: 32px;
        }

        li>a{
            position: absolute;
            top:2px;
            right:5px;
            display: block;
            width:26px;
            height:24px;
            border-radius: 14px;
            border: 6px double #fff;
            background: #ccc;
            line-height: 14px;
            text-align: center;
            color: #fff;
            font-weight: bold;
            cursor: pointer;
        }

        footer{
            color: #666;
            font-size: 14px;
            text-align: center;
        }
    </style>
</head>
<body>
    <header>
        <section>
            <label for="title">ToDoList</label>
            <input type="text" id="title" name="'title" placeholder="添加ToDo" autocomplete="off">
        </section>
    </header>
    <section>
        <h2 class="save">
            正在进行
            <span id="tdcount">1</span>
        </h2>
        <ol id="tdlist">
            <li>
                <input type="checkbox">
                <p>1111</p>
                <a>-</a>
                <span id="sj">shijian</span>
            </li>
        </ol>
        <h2>
            已经完成
            <span class="donecount">0</span>
        </h2>
        <ul id="donelist">

        </ul>
    </section>
    <footer>
        Copyright © 2014 todolist.cn
    </footer>
</body>
</html>
<script>
//    var arr=[
//        {id:1499848865300,context:'测试一号',status:false},
//        {id:1499848876195,context:'测试二号',status:true},
//        {id:1499848894042,context:'测试三号',status:true}
//    ];
//    localStorage.todo = JSON.stringify(arr)

    var database = [];

    init();
    //设置初始化函数
    function init() {
        var m = 0, n = 0;
        $('ol,ul').html('');
        if(localStorage.todo){
            database = JSON.parse(localStorage.todo);
        }
        database.forEach(function (value,index) {
            var type = value.status?'checked':'';
            var li = $("<li id="+value.id+">");
            var par;
            if(type){
                par = $('ul');
                n++;
                $('.donecount').html(n);
            }else{
                par = $('ol');
                m++;
                $('#tdcount').html(m);
            }
            li.html(`
                <input type="checkbox" ${type}>
                <p contenteditable="true">${value.context}</p>
                <a>-</a>
            `);
            li.appendTo(par);
            //如果子元素是0,计数器归零
            if($('ol').children().length==0){
                $('#tdcount').html(0);
            }else if($('ul').children().length==0){
                $('.donecount').html(0);
            }
        })


    }

    //键盘回车事件
    var flag = false;
    $('header input').focus(function () {
        flag = true;
    }).blur(function () {
        flag = false;
    })
    $(document).keydown(function (e) {
        if(e.which==13&&flag){
            var val = $('header input').val();
            console.log(val)
            if(val){
                var obj = {id:Date.now(),context:val,status:false};
                var li = $('<li id='+obj.id+'>');
                li.html(`
                    <input type="checkbox">
                    <p contenteditable="true">${obj.context}</p>
                    <a>-</a>
                `);
                li.appendTo($('ol'));
                database.push(obj);
                localStorage.todo=JSON.stringify(database);
                $('header input').val('')
                init();
            }else{
                alert('请输入正确的事情信息')
            }
        }
    })

    //利用事件委派制作删除已经更改状态
    $('section').delegate('li a','click',function () {
        var id = $(this).parent().attr('id');
        var index = database.findIndex(function (value,index) {
            return value.id==id;
        })
        database.splice(index,1);
        localStorage.todo=JSON.stringify(database);
        init();
    });
    //设置勾选更换状态
    $('section').on('click','input[type=checkbox]',function () {
        var id = $(this).parent().attr('id');
        var index = database.findIndex(function (value,index) {
            return value.id==id;
        });
        if($(this).attr('checked')){
            database[index].status=false;
        }else{
            database[index].status=true;
        }
        localStorage.todo=JSON.stringify(database);
        init();
    })
    //设置内容更改事件
    $('section').on('blur','p',function () {
        var id = $(this).parent().attr('id');
        var index = database.findIndex(function (value,index) {
            return value.id==id;
        });
        var val = $(this).text();
        database[index].context=val;
        localStorage.todo=JSON.stringify(database);
        init();

    })

</script>